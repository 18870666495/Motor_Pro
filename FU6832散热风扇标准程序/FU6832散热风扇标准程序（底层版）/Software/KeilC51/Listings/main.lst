C51 COMPILER V9.53.0.0   MAIN                                                              04/09/2024 13:54:54 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\User\source\Application\main.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE IN
                    -CDIR(..\FU68xx_Hardware_Driver\Include;..\User\include) DEBUG PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.o
                    -bj)

line level    source

   1          /* --------------------------- (C) COPYRIGHT 2020 Fortiortech ShenZhen -----------------------------
   2              File Name      : main.c
   3              Author         : Fortiortech  Appliction Team
   4              Version        : V1.0
   5              Date           : 2020-04-10
   6              Description    : This file contains .C file function used for Motor Control.
   7          ----------------------------------------------------------------------------------------------------
   8                                                 All Rights Reserved
   9          ------------------------------------------------------------------------------------------------- */
  10          /********************************************************************************
  11          * Header Definition
  12          ********************************************************************************/
  13          #include "FU68xx_4.h"
  14          #include "MyProject.h"
  15          
  16          #if (ROTATESIGNAL_TYPE != NO_TYPE)
  17           #include "SignalOutputControl.h"
  18          #endif
  19          
  20          #if (SPEED_MODE == PWMMODE)
               #include "PWM_SpeedControl.h"
              #endif
  23          
  24          #if (HPFCOL_Enable == 1)
               #include "HPFCOL_Function.h"
              #endif
  27          
  28          #if (AVC_TURBOFAN_Enable == 1)
               #include "turboFanFunction.h"
              #endif
  31          
  32          uint8 data g_1mTick = 0;  ///< 1msæ»´ç­”ä¿¡å·ï¼Œæ¯éš”1msåœ¨SYSTICKå®šæ—¶å™¨è¢«ç½®1ï¼Œéœ€åœ¨å¤§å¾ªç¯ä½¿ç
             -”¨å¤„æ¸…é›¶
  33          /********************************************************************************
  34          * Internal Routine Prototypes
  35          ********************************************************************************/
  36          void HardwareInit(void);
  37          void SoftwareInit(void);
  38          
  39          /********************************************************************************
  40          * Macro & Structure Definition
  41          ********************************************************************************/
  42          
  43          /********************************************************************************
  44          * Function Definition
  45          ********************************************************************************/
  46           
  47          uint16 RealVolt = 0;
  48           
  49          void main(void)
  50          {
  51   1        SoftwareInit();
  52   1        HardwareInit();
C51 COMPILER V9.53.0.0   MAIN                                                              04/09/2024 13:54:54 PAGE 2   

  53   1        
  54   1        EA = 1;             // ä¸­æ–·å‘é‡è‡´èƒ½
  55   1        
  56   1        while (1)
  57   1        {
  58   2          GetCurrentOffset();
  59   2          MC_Control();
  60   2          RealVolt = DcBus2Volt(ADCSampling.DcBus_Flt);
  61   2        #if (AVC_TURBOFAN_Enable == 1)
                  {
                    if (c_TurboFan.isActive == 0)
                    {
                      #if (SPEED_MODE == PWMMODE)
                      {
                        PWM_speedControl();
                      }
                      #elif (SPEED_MODE == NONEMODE)
                      {
                        mcSpeedRamp.FlagONOFF   = 1;
                        mcSpeedRamp.TargetValue = RPM2SpeedFlt(NONEMODE_SPEED);
                      }
                      #endif
                    }
                  }
                  #else
  78   2          {
  79   3            #if (SPEED_MODE == PWMMODE)
                    {
                      PWM_speedControl();
                    }
                    #elif (SPEED_MODE == VSPMODE)
  84   3            {
  85   4              VSP_speedControl();
  86   4            }      
  87   3            #elif (SPEED_MODE == NONEMODE)
                    {
                      mcSpeedRamp.FlagONOFF   = 1;
                      mcSpeedRamp.TargetValue = RPM2SpeedFlt(NONEMODE_SPEED);
                    }
                    #endif
  93   3          }
  94   2          #endif
  95   2      
  96   2          #if (ROTATESIGNAL_TYPE == FG_TYPE)
  97   2          {
  98   3            SignalOutput_Process();
  99   3          }
 100   2          #elif (ROTATESIGNAL_TYPE == RD_TYPE)
                  {
                    GP00 = SignalOutput_Process();
                  }
                  #endif
 105   2          
 106   2            
 107   2          /*TurboFan è™•ç†éšæ®µå‡½æ•¸ --é–‹å§‹*/    
 108   2          #if (AVC_TURBOFAN_Enable == 1)
                  {
                    TurboFan_ProcessEvent();
                  }
                  #endif
 113   2          /*TurboFan è™•ç†éšæ®µå‡½æ•¸ --çµæŸ*/
 114   2        }
C51 COMPILER V9.53.0.0   MAIN                                                              04/09/2024 13:54:54 PAGE 3   

 115   1      }
 116          
 117          /* -------------------------------------------------------------------------------------------------
 118              Function Name  : HardwareInit
 119              Description    : ç¡¬ä»¶åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–éœ€è¦ä½¿ç”¨çš„ç¡¬ä»¶è®¾å¤‡é…ç½®ï¼ŒFOCå¿…é¡»é…ç½®çš„æ˜¯è
             -¿æ”¾ç”µå‹ã€è¿æ”¾åˆå§‹åŒ–ã€ADCåˆå§‹åŒ–ã€Driveråˆå§‹åŒ–
 120                              ï¼Œå…¶ä»–çš„å¯æ ¹æ®å®é™…éœ€æ±‚åŠ ã€‚
 121              Date           : 2020-04-12
 122              Parameter      : None
 123          ------------------------------------------------------------------------------------------------- */
 124          void HardwareInit(void)
 125          {
 126   1        uint16 PowerUpCnt = 0;
 127   1        
 128   1        /************************VREF&VHALF Config************************/
 129   1        ClrBit(P3_AN, PIN5);                        //VREF Voltage -->P35 Output
 130   1        #if (HW_ADC_REF_Volt == REF_5V0)
 131   1        {
 132   2          ClrBit(VREF_VHALF_CR, VRVSEL1);           // 01-->VDD5
 133   2          SetBit(VREF_VHALF_CR, VRVSEL0);             
 134   2        }
 135   1        #elif (HW_ADC_REF_Volt == REF_4V5)
                {
                  ClrBit(VREF_VHALF_CR, VRVSEL1);           // 00-->4.5V
                  ClrBit(VREF_VHALF_CR, VRVSEL0);           
                }
                #elif (HW_ADC_REF_Volt == REF_4V0)
                {
                  SetBit(VREF_VHALF_CR, VRVSEL1);           // 11-->4.0V
                  SetBit(VREF_VHALF_CR, VRVSEL0);          
                }
                #elif (HW_ADC_REF_Volt == REF_3V0)
                {
                  SetBit(VREF_VHALF_CR, VRVSEL1);           // 10-->3.0V 
                  ClrBit(VREF_VHALF_CR, VRVSEL0);           
                }
                #else 
                {
                  #error "HW_ADC_REF setting error!"
                }
                #endif
 155   1      
 156   1        SetBit(VREF_VHALF_CR, VREFEN | VHALFEN);    //VREF_VHALF_CR = 0x11;
 157   1        /****************************************************************/
 158   1        // ä¸ºæé«˜èŠ¯ç‰‡çš„æŠ—å¹²æ‰°èƒ½åŠ›ï¼Œé™ä½èŠ¯ç‰‡åŠŸè€—ï¼Œè¯·åœ¨å…·ä½“é¡¹ç›®æ—¶ï¼Œå°†ä¸éœ€è¦ç”¨çš„GP
             -IOé»˜è®¤éƒ½é…ç½®ä¸ºè¾“å…¥ä¸Šæ‹‰ã€‚
 159   1        // å…·ä½“é…ç½®å¯åœ¨GPIO_Default_Initè®¾ç½®ã€‚
 160   1        //    GPIO_Default_Init();
 161   1        
 162   1        /************************ç¡¬ä»¶å¤–è®¾åˆå§‹åŒ–**************************/
 163   1      
 164   1        #if defined (SPI_DBG_HW)        // ç¡¬ä»¶è°ƒè¯•æ¨¡å¼
                {
                  SPI_Init();
                  Set_DBG_DMA(&HARD_SPIDATA);
                }
                #elif defined (SPI_DBG_SW)      // è½¯ä»¶è°ƒè¯•æ¨¡å¼
                {
                  SPI_Init();
                  Set_DBG_DMA(spidebug);
                }
                #elif defined (UART_DBG)        // UARTè°ƒè¯•æ¨¡å¼
C51 COMPILER V9.53.0.0   MAIN                                                              04/09/2024 13:54:54 PAGE 4   

                {
                  UART2_Init();
                  SetPipe_DMA0(DRAM_UART2);
                }
                #endif
 180   1      
 181   1        GPIO_Init();
 182   1        ADC_Init();
 183   1        Driver_Init();
 184   1        AMP_Init();
 185   1          
 186   1        /*è©²è¿´åœˆæœƒé€ æˆç³»çµ±å»¶é² 1S å•Ÿå‹•*/
 187   1        for (PowerUpCnt = 0; PowerUpCnt < SystemPowerUpTime; PowerUpCnt++);
 188   1          
 189   1        /******æ¯”è¾ƒå™¨ä¸­æ–­é…ç½®**********/
 190   1        CMP3_Interrupt_Init();
 191   1        CMP3_Init();
 192   1        
 193   1        #if (SPEED_MODE == PWMMODE || HPFCOL_Enable == 1)
                {
                  TIM3_Initial();
                }
                #endif
 198   1        
 199   1        #if (ROTATESIGNAL_TYPE == FG_TYPE || HPFCOL_Enable == 1)
 200   1        {
 201   2          TIM4_Initial();
 202   2        }
 203   1        #endif
 204   1        
 205   1        #if (AVC_TURBOFAN_Enable == 1)
                {
                  UART1_Init();
                }
                #endif
 210   1        
 211   1        sysTick_Initial();
 212   1        
 213   1        SetBit(DRV_SR, SYSTIE);
 214   1      }
 215          
 216          
 217          /* -------------------------------------------------------------------------------------------------
 218              Function Name  : SoftwareInit
 219              Description    : è½¯ä»¶åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ‰€æœ‰å®šä¹‰å˜é‡ï¼ŒæŒ‰é”®åˆå§‹åŒ–æ‰«æ
 220              Date           : 2020-04-12
 221              Parameter      : None
 222          ------------------------------------------------------------------------------------------------- */
 223          void SoftwareInit(void)
 224          {
 225   1        #if (HPFCOL_Enable == 1)
                {
                  HPFCOL_Initial();
                }
                #endif
 230   1        
 231   1        #if (MOTOR_STARTDELAY_Enable == 1)
                {
                  Motor_DelayStart_CNT = (MOTOR_STARTDELAY_TIME);
                  StartDelay_Flag = 0;
                }
                #endif
C51 COMPILER V9.53.0.0   MAIN                                                              04/09/2024 13:54:54 PAGE 5   

 237   1        
 238   1        /*TurboFan åˆå§‹åŒ–å‡½æ•¸ --é–‹å§‹*/  
 239   1        #if (AVC_TURBOFAN_Enable == 1)
                {
                  TurboFan_Initial();
                }
                #endif
 244   1        /*TurboFan åˆå§‹åŒ–å‡½æ•¸ --çµæŸ*/
 245   1        
 246   1        /*ä¿¡è™Ÿè¼¸å‡ºåˆå§‹åŒ–å‡½æ•¸ --é–‹å§‹*/
 247   1        #if (ROTATESIGNAL_TYPE != NO_TYPE)
 248   1        {
 249   2          SignalOutput_initial();
 250   2        }
 251   1        #endif
 252   1        /*ä¿¡è™Ÿè¼¸å‡ºåˆå§‹åŒ–å‡½æ•¸ --çµæŸ*/  
 253   1        
 254   1        /*Coast Mode åˆå§‹åŒ–å‡½æ•¸ --é–‹å§‹*/
 255   1        #if (AC_Lose_Function_Enable == 1)
 256   1        {
 257   2          DELL_coastMode_Initial();
 258   2        }
 259   1        #endif
 260   1        /*Coast Mode åˆå§‹åŒ–å‡½æ•¸ --çµæŸ*/ 
 261   1        
 262   1        MotorcontrolInit(); 
 263   1        mcState       = mcReady;
 264   1        mcFaultSource.Source = NoFault;
 265   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    159    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
