C51 COMPILER V9.53.0.0   HPFCOL_FUNCTION                                                   04/09/2024 13:54:53 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE HPFCOL_FUNCTION
OBJECT MODULE PLACED IN .\Objects\HPFCOL_Function.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\User\source\Application\HPFCOL_Function.c LARGE OMF2 OPTIMIZE(8,SPEED
                    -) BROWSE INCDIR(..\FU68xx_Hardware_Driver\Include;..\User\include) DEBUG PRINT(.\Listings\HPFCOL_Function.lst) TABS(2) O
                    -BJECT(.\Objects\HPFCOL_Function.obj)

line level    source

   1          /**
   2            ******************************************************************************
   3            * @file           : HPFCOL_Function.c
   4            * @copyright      : (c) 2022, Fortior Tech
   5            * @brief          : 
   6            * @date           : 2023-03-09
   7            * @version        : 1.0.1
   8            *
   9            ******************************************************************************
  10            * @attention
  11            *
  12            * This software is licensed under terms that can be found in the LICENSE file
  13            * in the root directory of this software component.
  14            * If no LICENSE file comes with this software, it is provided AS-IS.
  15            *
  16            ******************************************************************************
  17            */  
  18          
  19          /* Includes ------------------------------------------------------------------*/
  20          #include <FU68xx_4.h>
  21          
  22          /* Private includes ----------------------------------------------------------*/
  23          #include "MyProject.h"
  24          
  25          /* Private typedef -----------------------------------------------------------*/
  26          typedef enum{
  27            DetectTrig_Step = 0,       // HP-FCOL Ê™¢Ê∏¨Êåá‰ª§ÈöéÊÆµ
  28            Wait500mS_Step  = 1,       // HP-FCOL ÂâçÂ∞éÁ¢ºÂâçÁ∑©Ë°ùÈöéÊÆµ
  29            SendHeader_Step = 2,       // HP-FCOL ÁôºÈÄÅÂâçÂ∞éÁ¢ºÈöéÊÆµ
  30            Wait250mS_Step  = 3,       // HP-FCOL Ë≥áÊñôÂÇ≥ÈÄÅÂâçÁ∑©Ë°ùÈöéÊÆµ
  31            SendHPDATA_Step = 4,       // HP-FCOL Ë≥áÊñôÂÇ≥ÈÄÅÈöéÊÆµ
  32            SendEnd_Step    = 5,       // HP-FCOL Ë≥áÊñôÂÇ≥Ëº∏ÁµêÊùüÈöéÊÆµ
  33            WaitTffo_Step   = 6        // HP-FCOL Á≠âÂæÖÈÄöË®äÁ∑©Ë°ùÈöéÊÆµ
  34          }HPFCOL_STEP;
  35          
  36          
  37          /**
  38            * @brief HPFCOL_TyperDef ÁµêÊßãÂÆöÁæ©
  39            */
  40          typedef struct
  41          {
  42            HPFCOL_STEP  Send_Step;  /*!< HP-FCOL ÈöéÊÆµ */
  43            uint16 Tibc_CNT;         /*!< HP-FCOL Tibc ÊôÇÈñìË®àÊï∏ */
  44            
  45          #if (HPFCOL_SWCRC_CHECK_Enable == 1)
  46            uint8  DATA_Crc;         /*!< HP-FCOL Ë≥áÊñôCrc */
  47            
  48          #endif
  49          
  50            uint8  Trig_Flag;        /*!< HP-FCOL Êåá‰ª§Ëß∏ÁôºÊóóÊ®ô */
  51            uint8  Send_Flag;        /*!< HP-FCOL Ë≥áÊñôÂÇ≥ÈÄÅÊóóÊ®ô */
  52            uint16 Trig_CNT;         /*!< HP-FCOL Êåá‰ª§Ëß∏ÁôºË®àÊï∏Âô® */
  53            uint16 Delay_CNT;        /*!< HP-FCOL Âª∂ÈÅ≤Ë®àÊï∏Âô® */
C51 COMPILER V9.53.0.0   HPFCOL_FUNCTION                                                   04/09/2024 13:54:53 PAGE 2   

  54            uint16 PDS_Histroy;      /*!< HP-FCOL Ë™øÈÄüÂÄºÊö´Â≠ò --Ë£ú‰∏Å--*/
  55          }HPFCOL_TyperDef;
  56          
  57          
  58          /* Private define ------------------------------------------------------------*/
  59          #define HPFCOL_BitPeriod                      (720)                                   /*!< (ÂñÆ‰Ωç: uS) HP
             --FCOL ‰ΩçÂÖÉ‰ø°ËôüÈÄ±Êúü */
  60          #define HPFCOL_CommMinTime                    (400)                                   /*!< (ÂñÆ‰Ωç: mS) HP
             --FCOL ÊúÄ‰ΩéÊåá‰ª§ÊôÇÈñì */
  61          #define HPFCOL_CommMaxTime                    (600)                                   /*!< (ÂñÆ‰Ωç: mS) HP
             --FCOL ÊúÄÈ´òÊåá‰ª§ÊôÇÈñì */
  62          #define HPFCOL_Preamble_IdleTime              (500)                                   /*!< (ÂñÆ‰Ωç: mS) HP
             --FCOL ÂâçÂ∞éÁ¢ºÂâçÁ∑©Ë°ùÊôÇÈñì */
  63          #define HPFCOL_Transfer_IdleTime              (250)                                   /*!< (ÂñÆ‰Ωç: mS) HP
             --FCOL Ë≥áÊñôÂÇ≥ÈÄÅÂâçÁ∑©Ë°ùÊôÇÈñì */
  64          #define HPFCOL_Tffo_Time                      (1000)                                  /*!< (ÂñÆ‰Ωç: mS) HP
             --FCOL ÂÇ≥Ëº∏ÁµêÊùüÁ∑©Ë°ùÊôÇÈñì */
  65          #define HPFCOL_Min_TibcTime                   (2000)                                  /*!< (ÂñÆ‰Ωç: mS) HP
             --FCOL ÈÄöË®äÁ∑©Ë°ùÊôÇÈñì */
  66          #define HPFCOL_TESTLen                        (64)                                    /*!< HP-FCOL Ë≥áÊñôÈ
             -ï∑Â∫¶ [ÁØÑÂúç: 1 ~ 127] */
  67          
  68          /* Private macro -------------------------------------------------------------*/
  69          #define HPFCOL_BIT_TIMARR                     (uint16)((float)HPFCOL_BitPeriod / (float)(1000000.0f / FG_T
             -IMCLOCK))
  70          #define HPFCOL_BITTIMUNIT                     (HPFCOL_BIT_TIMARR / 4)
  71          
  72          /* Private variables ---------------------------------------------------------*/
  73          extern code unsigned char HPFCOL_Data[64];
  74          HPFCOL_TyperDef HPFCOL;
  75          
  76          /* Private function prototypes -----------------------------------------------*/   
  77          
  78          /* Private user code ---------------------------------------------------------*/
  79          /**
  80            * @brief  HP-FCOL ÂàùÂßãÂåñÂáΩÊï∏
  81            * @note   Êú¨ÂáΩÊï∏ÂÉÖËÉΩÂú®SoftwareInit() ÂáΩÊï∏‰∏≠Ë™øÁî®„ÄÇ
  82            * @retval ÁÑ°
  83            */
  84          void HPFCOL_Initial(void)
  85          {
  86   1        #if (HPFCOL_SWCRC_CHECK_Enable == 1)
  87   1        {
  88   2          HPFCOL.DATA_Crc = SW_CRC8_Calc(&HPFCOL_Data[0], 63);
  89   2        }
  90   1        #endif
  91   1      }
  92          
  93          
  94          /**
  95            * @brief  HP-FCOL TIM4 ÂàùÂßãÂåñÂáΩÊï∏
  96            * @retval ÁÑ°
  97            */
  98          void TIM4_HPFCOL_Initial()
  99          {
 100   1        ClrBit(PH_SEL, T4SEL);
 101   1        ClrBit(TIM4_CR0, T4IRE);
 102   1        
 103   1        SetReg(TIM4_CR0, (T4PSC2 | T4PSC1 | T4PSC0), FG_ClockBase);
 104   1        SetReg(TIM4_CR0, (T4MOD),                    TIM_PWM_Mode);
 105   1        SetReg(TIM4_CR0, (T4OCM),                    TIM_OCNPOLARITY_HIGH);
 106   1        SetReg(TIM4_CR1, (T4NM1 | T4NM0),            TIM_TriggerFilter_NONE);
C51 COMPILER V9.53.0.0   HPFCOL_FUNCTION                                                   04/09/2024 13:54:53 PAGE 3   

 107   1        SetReg(PH_SEL1,  (T4CT),                     TIM4_CHANNEL_1);
 108   1        SetReg(TIM4_CR1, (T4IPE | T4IFE), TIM_TS_TI1F);
 109   1        SetReg(TIM4_CR0, (T4IRE),         TIS_TS_TI1R);
 110   1        
 111   1        TIM4__ARR  = HPFCOL_BIT_TIMARR;
 112   1        TIM4__DR   = HPFCOL_BIT_TIMARR + 1;
 113   1        TIM4__CNTR = 0;
 114   1        
 115   1        PTIM41 = 1;
 116   1        PTIM40 = 1;
 117   1        
 118   1        SetBit(TIM4_CR1, T4EN);
 119   1      }
 120          
 121          
 122          /**
 123            * @brief  HP-FCOL ÈÄöË®äÊ™¢Ê∏¨ÂáΩÊï∏
 124            * @retval ÁÑ°
 125            */
 126          void HPFCOL_CommDetection(void)
 127          {
 128   1        static uint8 IF_Flag = 0;
 129   1      
 130   1        if (ReadBit(TIM3_CR1, T3IF) && ReadBit(P0, PIN1))
 131   1        {
 132   2          // Ëß∏ÁôºËΩâÈÄüÁ¥ÄÈåÑÂô®
 133   2          if (IF_Flag == 0)
 134   2          {
 135   3            HPFCOL.Delay_CNT = HPFCOL_CommMaxTime;
 136   3            IF_Flag = 1;
 137   3          }
 138   2      
 139   2          // Ëß∏ÁôºHP-FCOL Êåá‰ª§ÊóóÊ®ô
 140   2          if (HPFCOL.Send_Flag == 0)
 141   2          {
 142   3            HPFCOL.Trig_Flag = 1;
 143   3          }
 144   2        }
 145   1      
 146   1        else if (ReadBit(TIM3_CR1, T3IP) || (ReadBit(TIM3_CR1, T3IF) && !ReadBit(P0, PIN1)))
 147   1        { 
 148   2          // Ëß∏ÁôºËΩâÈÄüÁ¥ÄÈåÑÂô®
 149   2          if (ReadBit(TIM3_CR1, T3IP))
 150   2          {
 151   3            IF_Flag = 0;
 152   3            HPFCOL.PDS_Histroy = mcPWM_Input.Duty;
 153   3          }
 154   2      
 155   2          if (HPFCOL.Send_Flag == 0)
 156   2          {
 157   3            // Á¢∫Ë™çÊåá‰ª§ÈöéÊÆµ
 158   3            if ((HPFCOL.Trig_CNT > HPFCOL_CommMinTime) && (HPFCOL.Trig_CNT < HPFCOL_CommMaxTime) && (HPFCOL.Trig
             -_Flag == 1))
 159   3            {
 160   4              HPFCOL.Tibc_CNT  = (HPFCOL_Min_TibcTime - HPFCOL.Trig_CNT);
 161   4              HPFCOL.Send_Step = Wait500mS_Step;
 162   4              HPFCOL.Send_Flag = 1;
 163   4              SignalOutput_Pause();
 164   4            }
 165   3            HPFCOL.Trig_CNT = 0;
 166   3            HPFCOL.Trig_Flag = 0;
 167   3          }
C51 COMPILER V9.53.0.0   HPFCOL_FUNCTION                                                   04/09/2024 13:54:53 PAGE 4   

 168   2        }
 169   1      }
 170          
 171          
 172          /**
 173            * @brief  HP-FCOL Ë®àÊï∏Âô®‰∫ã‰ª∂ÂáΩÊï∏
 174            * @notes  Êú¨ÂáΩÊï∏ÂÉÖËÉΩÂú®SYSTick() ‰∏≠Êñ∑Ë£°Ë™øÁî®
 175            * @retval ÁÑ°
 176            */
 177          void HPFCOLCounter_Event(void)
 178          {
 179   1        static int16 l_Counter = HPFCOL_Preamble_IdleTime;
 180   1      
 181   1        // Êåá‰ª§Èï∑Â∫¶Ë®àÊï∏Âô®
 182   1        if ((HPFCOL.Trig_Flag == 1) && (HPFCOL.Trig_CNT < HPFCOL_CommMaxTime) && (HPFCOL.Send_Flag == 0))
 183   1        {
 184   2          HPFCOL.Trig_CNT++;
 185   2        }
 186   1        
 187   1        if (HPFCOL.Delay_CNT != 0)
 188   1        {
 189   2          HPFCOL.Delay_CNT--;
 190   2        }
 191   1        
 192   1        switch(HPFCOL.Send_Step)
 193   1        {
 194   2          case Wait500mS_Step:
 195   2          {
 196   3            if (l_Counter != 0)
 197   3            {
 198   4              l_Counter--;
 199   4            }
 200   3            else
 201   3            {
 202   4              l_Counter = HPFCOL_Transfer_IdleTime;
 203   4              TIM4_HPFCOL_Initial();
 204   4              SetBit(PH_SEL, T4SEL);
 205   4              HPFCOL.Send_Step = SendHeader_Step;
 206   4            }
 207   3            break;
 208   3          }
 209   2          case Wait250mS_Step:
 210   2          {
 211   3            if (l_Counter != 0)
 212   3            {
 213   4              l_Counter--;
 214   4            }
 215   3            else
 216   3            {
 217   4              TIM4__CNTR = 0;
 218   4              TIM4__ARR = HPFCOL_BIT_TIMARR;
 219   4              TIM4__DR = HPFCOL_BITTIMUNIT;
 220   4              HPFCOL.Send_Step = SendHPDATA_Step;
 221   4              SetBit(PH_SEL, T4SEL);
 222   4            }
 223   3            break;
 224   3          }
 225   2          case SendEnd_Step:
 226   2          {
 227   3            HPFCOL.Send_Step = WaitTffo_Step;
 228   3            l_Counter = HPFCOL_Tffo_Time;
 229   3            break;
C51 COMPILER V9.53.0.0   HPFCOL_FUNCTION                                                   04/09/2024 13:54:53 PAGE 5   

 230   3          }
 231   2          case WaitTffo_Step:
 232   2          {
 233   3            if (l_Counter != 0)
 234   3            {
 235   4              l_Counter--;
 236   4            }
 237   3            else  if (l_Counter == 0) 
 238   3            {
 239   4              l_Counter = -1;
 240   4              #if (ROTATESIGNAL_TYPE != RD_TYPE)
 241   4              {
 242   5                TIM4_Initial();
 243   5              }
 244   4              #endif
 245   4              SignalOutput_Continue();
 246   4            }
 247   3      
 248   3          
 249   3            
 250   3            if (HPFCOL.Tibc_CNT != 0) 
 251   3            {
 252   4              HPFCOL.Tibc_CNT--;
 253   4            }
 254   3            else
 255   3            {
 256   4              //ClrBit(PH_SEL, T4SEL);
 257   4              HPFCOL.Send_Step = DetectTrig_Step;
 258   4              l_Counter = HPFCOL_Preamble_IdleTime;
 259   4              HPFCOL.Send_Flag = 0;
 260   4            }
 261   3            break;
 262   3          }
 263   2        }
 264   1      }
 265          
 266          
 267          /**
 268            * @brief  HP-FCOL Êõ¥Êñ∞‰∫ã‰ª∂ÂáΩÊï∏
 269            * @retval ÁÑ°
 270            */
 271          void HPFCOLUpdate_Event(void)
 272          {
 273   1        static uint8 l_Counter = 0, FCOL_Posi = 0, dBit = 0;
 274   1        if (ReadBit(TIM4_CR1, T4IR) && HPFCOL.Send_Flag == 1)
 275   1        {
 276   2          if (HPFCOL.Send_Step == SendHPDATA_Step)
 277   2          {
 278   3            //ClrBit(TIM4_CR1, T4EN);
 279   3            if (FCOL_Posi >= HPFCOL_TESTLen)
 280   3            {
 281   4              HPFCOL.Send_Step = SendEnd_Step;
 282   4              ClrBit(PH_SEL, T4SEL);
 283   4              GP00 = 1;
 284   4              FCOL_Posi = 0;
 285   4              l_Counter  = 0;
 286   4            }
 287   3          }
 288   2        }
 289   1          
 290   1        if (ReadBit(TIM4_CR1, T4IF) && (HPFCOL.Send_Flag == 1))
 291   1        {
C51 COMPILER V9.53.0.0   HPFCOL_FUNCTION                                                   04/09/2024 13:54:53 PAGE 6   

 292   2          if (HPFCOL.Send_Step == SendHeader_Step)
 293   2          {
 294   3            if (l_Counter++ == 4)
 295   3            {
 296   4              ClrBit(PH_SEL, T4SEL);
 297   4              HPFCOL.Send_Step = Wait250mS_Step;
 298   4              SetReg(TIM4_CR0, (T4OCM), TIM_OCNPOLARITY_LOW);
 299   4              GP00 = 1;
 300   4              l_Counter = 1;
 301   4            }
 302   3            else
 303   3            {
 304   4              if ((l_Counter & 1) == 0)
 305   4              {
 306   5                SetReg(TIM4_CR0, (T4OCM), TIM_OCNPOLARITY_HIGH);
 307   5              }
 308   4              else
 309   4              {
 310   5                SetReg(TIM4_CR0, (T4OCM), TIM_OCNPOLARITY_LOW);
 311   5              }
 312   4            }
 313   3          }
 314   2          else if (HPFCOL.Send_Step == SendHPDATA_Step)
 315   2          {
 316   3            if (FCOL_Posi < HPFCOL_TESTLen)
 317   3            {
 318   4              #if (HPFCOL_SWCRC_CHECK_Enable == 1)
 319   4              {
 320   5                if (FCOL_Posi < (HPFCOL_TESTLen - 1))
 321   5                {
 322   6                  dBit = (((HPFCOL_Data[FCOL_Posi] << l_Counter) & 0x80)? (2) : (0));
 323   6                }
 324   5                else
 325   5                {
 326   6                  dBit = (((HPFCOL.DATA_Crc << l_Counter) & 0x80)? (2) : (0));
 327   6                }
 328   5              }
 329   4              #elif (HPFCOL_SWCRC_CHECK_Enable == 0)
                      {
                        dBit = (((HPFCOL_Data[FCOL_Posi] << l_Counter) & 0x80)? (2) : (0));
                      }
                      #endif
 334   4              
 335   4              TIM4__DR = HPFCOL_BITTIMUNIT + (dBit * HPFCOL_BITTIMUNIT);
 336   4              
 337   4              if ((++l_Counter) >= 8)
 338   4              {
 339   5                FCOL_Posi++;
 340   5                l_Counter = 0;
 341   5              }
 342   4            }
 343   3      
 344   3          }
 345   2        }
 346   1      }
 347          
 348          
 349          /**
 350            * @brief    HP-FCOL ÈÄöË®äÊåá‰ª§Ë≠òÂà•ÂáΩÊï∏ --Ë£ú‰∏Å--
 351            * @note     Êú¨ÂáΩÊï∏Áî®ÊñºÊé•Êî∂Êåá‰ª§ÁãÄÊÖãÊôÇÔºå‰ΩøÈõªÊ©üÁ∂≠ÊåÅÁï∂ÂâçËΩâÈÄüÔºåÁî®‰ª•ÈÅøÂÖçÊé•Êî∂Êåá‰ª
             -§ÊôÇÂá∫ÁèæÂ∞èÂπÖÂ∫¶Âä†ÈÄüÁèæË±°„ÄÇ
 352            * @warning  Ê≠§Ë£ú‰∏ÅÁÇ∫ÈáùÂ∞ç PWM_speedControl() ÂáΩÊï∏ÊâÄË®≠Ë®àÁöÑÂáΩÊï∏Ôºå‰∏çÂæóÂÜç‰ªª‰ΩïÂú∞ÊñπË™øÁî®
C51 COMPILER V9.53.0.0   HPFCOL_FUNCTION                                                   04/09/2024 13:54:53 PAGE 7   

             -„ÄÇ
 353            * @retval   ÁÑ°
 354            */
 355          uint16 HPFCOL_SpeedControl(uint16 VSP)
 356          {
 357   1        return (HPFCOL.Delay_CNT != 0)? (HPFCOL.PDS_Histroy) : (VSP);
 358   1      }
 359          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    826    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     18    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
